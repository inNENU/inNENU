# AI 聊天页面实现

## 概述

本页面集成了 Dify AI 服务，为用户提供智能聊天功能。

## 功能特性

### 聊天界面

- 支持用户和AI助手的对话显示
- 消息时间显示（今天显示时间，昨天显示"昨天"，其他显示日期）
- 加载动画显示
- 支持消息列表自动滚动

### 交互功能

- 文本输入框支持发送消息
- 支持键盘回车发送
- 清空对话功能
- 加载状态反馈

### 样式特性

- 响应式设计
- 暗色模式适配
- 现代化UI设计
- 安全区域适配

## 技术实现

### 文件结构

- `ai.ts` - 页面逻辑控制
- `ai.wxml` - 页面模板
- `ai.scss` - 样式文件
- `ai.wxs` - 时间格式化工具
- `dify.ts` - Dify API 接口封装

### 核心配置

#### 常量配置 (constant.ts)

```typescript
export const DIFY_API_BASE_URL = "https://search-ai.cn";
export const DIFY_API_TOKEN = "YOUR_DIFY_API_TOKEN";
export const DIFY_API_KEY = "YOUR_DIFY_API_KEY";
```

#### 用户标识符

- 系统会自动从 `state/user.ts` 获取用户的 OpenID 作为 Dify 对话的用户标识符
- 如果用户未登录或 OpenID 不可用，则使用 "anonymous_user" 作为默认标识符
- 这确保了每个用户都有独立的对话上下文和个性化体验

#### API 接口

- 支持对话上下文保持
- 错误处理和重试机制
- 类型安全的接口定义
- 自动使用用户 OpenID 作为标识符，为每个用户提供个性化对话体验

## 使用说明

### 配置步骤

1. 在 `app/config/constant.ts` 中配置正确的 Dify API Token 和 API Key
2. 确保小程序配置中已添加 `https://search-ai.cn` 到请求域名白名单
3. 在小程序后台配置相应的网络权限

### 部署注意事项

- 确保 Dify 服务器地址可访问
- API Token 需要有效且权限正确
- 网络请求需要符合小程序的域名限制

## 自定义扩展

### 修改样式

可以通过修改 `ai.scss` 文件来自定义聊天界面的外观。

### 扩展功能

- 可以在 `dify.ts` 中添加更多 API 方法
- 可以在 `ai.ts` 中添加更多交互功能
- 支持添加文件上传、语音识别等高级功能

## 故障排除

### 常见问题

1. **消息发送失败**: 检查网络连接和 API 配置
2. **样式异常**: 检查 SCSS 编译和主题适配
3. **时间显示错误**: 检查 WXS 文件的时间格式化逻辑

### 调试建议

- 使用微信开发者工具的网络面板查看API请求
- 查看控制台日志获取详细错误信息
- 确认 Dify 服务状态正常
