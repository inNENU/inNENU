import{t as j}from"./transformRpx.js";const a={},H=function(s,t){const e=s.detail;let i=[];const o=a[e.id];if(!o||!o.list)return;const l=o.list,p=e.data,u=p.beginIndex,n=p.endIndex;if(o.pos=p,typeof u=="undefined"||u===-1||typeof n=="undefined"||n===-1)i=[];else{let h=-1;for(h=u;h<l.length&&h<=n;h++)h>=p.ignoreBeginIndex&&h<=p.ignoreEndIndex||i.push(l[h])}const r={};r[o.key]=i;const m=this.selectComponent("#"+e.id);r[m.data.batchKey]=!this.data.batchSetRecycleData,m._setInnerBeforeAndAfterHeight({beforeHeight:p.minTop,afterHeight:p.afterHeight}),this.setData(r,()=>{typeof t=="function"&&t()})};var k=s=>{throw TypeError(s)},K=(s,t,e)=>t.has(s)||k("Cannot "+e),D=(s,t,e)=>t.has(s)?k("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e),C=(s,t,e)=>(K(s,t,"access private method"),e),y,S;const z=200;function R(s,t){if(!t)return s;if(typeof s[t]!="undefined")return s[t];const e=t.split(".");for(let i=0;i<e.length;i++)if(s=s[e[i]],typeof s=="undefined"||typeof s=="object"&&!s)return;return s}function v(s,t){Object.prototype.toString.call(t)!=="[object Array]"&&(t=[t]);const e={};for(let i=0;i<t.length;i++)e[t[i]]=R(s,t[i]);return e}function _(s){return Object.prototype.toString.call(s)==="[object Array]"}function E(s,t){if(typeof s!=typeof t)return!1;if(_(s)&&_(t)){if(s.length!==t.length)return!1;for(let e=0;e<s.length;e++)if(s[e]!==t[e])return!1;return!0}return s===t}function O(s,t,e){_(e)||(e=[e]);for(let i=0;i<e.length;i++)if(!E(R(s,e[i]),R(t,e[i])))return!1;return!0}class B{constructor({id:t,dataKey:e,page:i,itemSize:o,useInPage:l,placeholderClass:p,root:u}){if(D(this,y),this.isDataReady=!1,!t||!e||!i||!o)throw new Error("parameter id, dataKey, page, itemSize is required");if(typeof o!="function"&&typeof o!="object")throw new Error("parameter itemSize must be function or object with key width and height");if(typeof o=="object"&&(!o.width||!o.height)&&(!o.props||!o.queryClass||!o.dataKey))throw new Error("parameter itemSize must be function or object with key width and height");if(this.id=t,this.dataKey=e,this.page=i,this.root=u,this.placeholderClass=p,i._recycleViewportChange=H,this.comp=i.selectComponent("#"+t),this.itemSize=o,this.itemSizeOpt=o,this.useInPage=l||!1,this.comp&&(this.comp.context=this,this.comp.setPage(i),this.comp.setUseInPage(this.useInPage)),this.useInPage&&!this.root)throw new Error("parameter root is required when useInPage is true");this.useInPage&&(this.oldPageScroll=this.root.onPageScroll,this.root.onPageScroll=n=>{var r;this.comp&&this.comp._scrollViewDidScroll({detail:{scrollLeft:0,scrollTop:n.scrollTop}}),(r=this.oldPageScroll)==null||r.apply(this.root,[n])},this.oldReachBottom=this.root.onReachBottom,this.root.onReachBottom=n=>{this.comp&&this.comp.triggerEvent("scrolltolower",{}),this.oldReachBottom.apply(this.root,[n])},this.oldPullDownRefresh=this.root.onPullDownRefresh,this.root.onPullDownRefresh=n=>{this.comp&&this.comp.triggerEvent("scrolltoupper",{}),this.oldPullDownRefresh.apply(this.root,[n])})}checkComp(){if(!this.comp)if(this.comp=this.page.selectComponent("#"+this.id),this.comp)this.comp.setUseInPage(this.useInPage),this.comp.context=this,this.comp.setPage(this.page);else throw new Error("the recycle-view correspond to this context is detached, please create another RecycleContext")}_recalculateSizeByProp(t,e){const i=this.itemSizeOpt;let o=this.propValueMap||[];const l=[],p=[];i.cacheKey&&(o=wx.getStorageSync(i.cacheKey)||[]),this.autoCalculateSize=!0;const u=[];for(let h=0;h<t.length;h++){let g=o.length;if(!o.length){const c=v(t[h],i.props);c.__index__=h,o.push(c),l.push(t[h]),p.push(g),u.push({index:h,sizeIndex:g});continue}let f=!1;for(let c=0;c<o.length;c++)if(O(o[c],t[h],i.props)){g=c,f=!0;break}if(!f){const c=v(t[h],i.props);c.__index__=h,o.push(c),l.push(t[h]),p.push(g)}u.push({index:h,sizeIndex:g})}this.propValueMap=o,o.length>10&&console.warn("[recycle-view] get itemSize count exceed maximum of 10, now got",o);const n=this;function r(h,g){const f=u[g];if(!f)throw console.error("[recycle-view] auto calculate size array error, no map size found",h,g,u),new Error("[recycle-view] auto calculate size array error, no map size found");const c=o[f.sizeIndex];if(!c)throw console.log("[recycle-view] auto calculate size array error, no size found",h,g,f,o),new Error("[recycle-view] auto calculate size array error, no size found");return{width:c.width,height:c.height}}function m(h){h.forEach((f,c)=>{const d=p[c];o[d].width=f.width,o[d].height=f.height}),n.itemSize=r;const g=n._recalculateSize(t);i.cacheKey&&wx.setStorageSync(i.cacheKey,o),e&&e(g)}if(l.length){const h={};h[i.dataKey]=l,this.page.setData(h,()=>{wx.createSelectorQuery().selectAll("."+i.queryClass).boundingClientRect(g=>{m(g)}).exec()})}else{n.itemSize=r;const h=n._recalculateSize(t);e&&e(h)}}_recalculateSize(t){const e={},i=this.itemSize,o=typeof i=="function",l=this.comp,p=l.data;let u=0,n=0,r=0,m=0;const h=[],g=t.length;for(let c=0;c<g;c++){t[c].__index__=c;let d={};if(o?d=i&&i.call(this,t[c],c):d={width:i.width,height:i.height},d=Object.assign({},d),h.push(d),u+d.width>p.width){if(m=0,u=d.width,h.length>=2?n+=h[h.length-2].height||0:n+=d.height,n>=z*(r+1)){const b=c-1,x=r;r+=parseInt((n-z*r)/z,10);for(let w=x;w<r;w++){const I=`${w}.${m}`;e[I]||(e[I]=[]),e[I].push(b)}}if(c===0)d.beforeHeight=0;else{const b=h[h.length-2];d.beforeHeight=b.beforeHeight+b.height}}else u>=z*(m+1)&&m++,u+=d.width,c===0?d.beforeHeight=0:d.beforeHeight=h[h.length-2].beforeHeight;const P=`${r}.${m}`;if(e[P]||(e[P]=[]),e[P].push(c),g-1===c&&d.height>z){const b=r;n+=d.height,r+=parseInt((n-z*r)/z,10);for(let x=b;x<=r;x++){const w=`${x}.${m}`;e[w]||(e[w]=[]),e[w].push(c)}}}const f={array:h,map:e,totalHeight:h.length?h[h.length-1].beforeHeight+h[h.length-1].height:0};return l.setItemSize(f),f}deleteList(t,e,i){this.checkComp();const o=this.id;return a[o]?(a[o].list.splice(t,e),C(this,y,S).call(this,o,i),this):this}updateList(t,e,i){this.checkComp();const o=this.id;if(!a[o])return this;const l=a[o].list.length;for(let p=0;p<e.length&&t<l;p++)a[o].list[t++]=e[p];return C(this,y,S).call(this,o,i),this}update(...t){this.updateList(...t)}splice(t,e,i,o){this.checkComp();const l=this.id,p=this.dataKey;if(typeof t=="object"&&t.length&&(o=e,i=t),typeof i=="function"&&(o=i,i=[]),!a[l])a[l]={key:p,id:l,list:i||[],sizeMap:{},sizeArray:[]};else{a[l].dataKey=p;const u=a[l].list;i&&i.length?u.splice(t,e,...i):u.splice(t,e)}return C(this,y,S).call(this,l,o),this}append(t,e){this.checkComp();const i=this.id,o=this.dataKey;return a[i]?(a[i].dataKey=o,a[i].list=a[i].list.concat(t)):a[i]={key:o,id:i,list:t,sizeMap:{},sizeArray:[]},C(this,y,S).call(this,i,e),this}destroy(){return this.useInPage&&(this.page.onPullDownRefresh=this.oldPullDownRefresh,this.page.onReachBottom=this.oldReachBottom,this.page.onPageScroll=this.oldPageScroll,this.oldPageScroll=this.oldReachBottom=this.oldPullDownRefresh=null),this.page=null,this.comp=null,a[this.id]&&delete a[this.id],this}forceUpdate(t,e){return this.checkComp(),e?this.comp.reRender(()=>{C(this,y,S).call(this,this.id,t)}):C(this,y,S).call(this,this.id,t),this}getBoundingClientRect(t){if(this.checkComp(),!a[this.id])return null;const e=a[this.id].sizeArray;if(!e||!e.length)return null;if(typeof t=="undefined"){const i=[];for(let o=0;o<e.length;o++)i.push({left:0,top:e[o].beforeHeight,width:e[o].width,height:e[o].height});return i}return t=parseInt(t,10),t>=e.length||t<0?null:{left:0,top:e[t].beforeHeight,width:e[t].width,height:e[t].height}}getScrollTop(){return this.checkComp(),this.comp.currentScrollTop||0}transformRpx(t,e){return typeof t=="number"&&(t+="rpx"),parseFloat(j(t,e))}getViewportItems(t){this.checkComp();const e=this.comp.getIndexesInViewport(t);if(e.length<=0)return[];const i=[],o=a[this.id].list;for(let l=0;l<e.length;l++)i.push(o[e[l]]);return i}getTotalHeight(){return this.checkComp(),this.comp.getTotalHeight()}getList(){return a[this.id]?a[this.id].list:[]}}y=new WeakSet,S=function(s,t){this.isDataReady=!0;let e=null,i=null,o=0;const l=()=>{if(!e||!i)return;const n=[];for(let r=0;r<o;r++)n.push({left:e[r].left-i.left,top:e[r].top-i.top,width:e[r].width,height:e[r].height});this.comp.setPlaceholderImage(n,{width:i.width,height:i.height})},p=()=>{if(t&&t(),this.autoCalculateSize&&this.placeholderClass){const n=[];this.placeholderClass.forEach(r=>{n.push(`.${this.itemSizeOpt.queryClass} .`+r)}),o=n.length,wx.createSelectorQuery().selectAll(n.join(",")).boundingClientRect(r=>{r.length<o||(e=r,l())}).exec(),wx.createSelectorQuery().select("."+this.itemSizeOpt.queryClass).boundingClientRect(r=>{i=r,l()}).exec()}};if(Object.prototype.toString.call(this.itemSizeOpt)==="[object Object]"&&this.itemSizeOpt&&!this.itemSizeOpt.width){this._recalculateSizeByProp(a[s].list,function(n){a[s].sizeMap=n.map,a[s].sizeArray=n.array,this.comp.forceUpdate(p)});return}const u=this._recalculateSize(a[s].list);a[s].sizeMap=u.map,a[s].sizeArray=u.array,this.comp.forceUpdate(t)};const A=s=>new B(s);export{A as createRecycleContext};
//# sourceMappingURL=index.js.map
